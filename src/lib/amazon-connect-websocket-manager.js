const global = typeof global !== 'undefined' ? global :
                typeof self !== 'undefined' ? self :
                    typeof window !== 'undefined' ? window : {};
global.connect = global.connect || {};
const currentWebsocketManager = connect.WebSocketManager;

(()=>{var e={975:(e,n,t)=>{var o;!function(){"use strict";var r={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/[bcdiefguxX]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[+-]/};function i(e){return function(e,n){var t,o,c,a,s,u,l,d,p,f=1,g=e.length,b="";for(o=0;o<g;o++)if("string"==typeof e[o])b+=e[o];else if("object"==typeof e[o]){if((a=e[o]).keys)for(t=n[f],c=0;c<a.keys.length;c++){if(null==t)throw new Error(i('[sprintf] Cannot access property "%s" of undefined value "%s"',a.keys[c],a.keys[c-1]));t=t[a.keys[c]]}else t=a.param_no?n[a.param_no]:n[f++];if(r.not_type.test(a.type)&&r.not_primitive.test(a.type)&&t instanceof Function&&(t=t()),r.numeric_arg.test(a.type)&&"number"!=typeof t&&isNaN(t))throw new TypeError(i("[sprintf] expecting number but found %T",t));switch(r.number.test(a.type)&&(d=t>=0),a.type){case"b":t=parseInt(t,10).toString(2);break;case"c":t=String.fromCharCode(parseInt(t,10));break;case"d":case"i":t=parseInt(t,10);break;case"j":t=JSON.stringify(t,null,a.width?parseInt(a.width):0);break;case"e":t=a.precision?parseFloat(t).toExponential(a.precision):parseFloat(t).toExponential();break;case"f":t=a.precision?parseFloat(t).toFixed(a.precision):parseFloat(t);break;case"g":t=a.precision?String(Number(t.toPrecision(a.precision))):parseFloat(t);break;case"o":t=(parseInt(t,10)>>>0).toString(8);break;case"s":t=String(t),t=a.precision?t.substring(0,a.precision):t;break;case"t":t=String(!!t),t=a.precision?t.substring(0,a.precision):t;break;case"T":t=Object.prototype.toString.call(t).slice(8,-1).toLowerCase(),t=a.precision?t.substring(0,a.precision):t;break;case"u":t=parseInt(t,10)>>>0;break;case"v":t=t.valueOf(),t=a.precision?t.substring(0,a.precision):t;break;case"x":t=(parseInt(t,10)>>>0).toString(16);break;case"X":t=(parseInt(t,10)>>>0).toString(16).toUpperCase()}r.json.test(a.type)?b+=t:(!r.number.test(a.type)||d&&!a.sign?p="":(p=d?"+":"-",t=t.toString().replace(r.sign,"")),u=a.pad_char?"0"===a.pad_char?"0":a.pad_char.charAt(1):" ",l=a.width-(p+t).length,s=a.width&&l>0?u.repeat(l):"",b+=a.align?p+t+s:"0"===u?p+s+t:s+p+t)}return b}(function(e){if(a[e])return a[e];for(var n,t=e,o=[],i=0;t;){if(null!==(n=r.text.exec(t)))o.push(n[0]);else if(null!==(n=r.modulo.exec(t)))o.push("%");else{if(null===(n=r.placeholder.exec(t)))throw new SyntaxError("[sprintf] unexpected placeholder");if(n[2]){i|=1;var c=[],s=n[2],u=[];if(null===(u=r.key.exec(s)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(c.push(u[1]);""!==(s=s.substring(u[0].length));)if(null!==(u=r.key_access.exec(s)))c.push(u[1]);else{if(null===(u=r.index_access.exec(s)))throw new SyntaxError("[sprintf] failed to parse named argument key");c.push(u[1])}n[2]=c}else i|=2;if(3===i)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");o.push({placeholder:n[0],param_no:n[1],keys:n[2],sign:n[3],pad_char:n[4],align:n[5],width:n[6],precision:n[7],type:n[8]})}t=t.substring(n[0].length)}return a[e]=o}(e),arguments)}function c(e,n){return i.apply(null,[e].concat(n||[]))}var a=Object.create(null);n.sprintf=i,n.vsprintf=c,"undefined"!=typeof window&&(window.sprintf=i,window.vsprintf=c,void 0===(o=function(){return{sprintf:i,vsprintf:c}}.call(n,t,n,e))||(e.exports=o))}()}},n={};function t(o){var r=n[o];if(void 0!==r)return r.exports;var i=n[o]={exports:{}};return e[o](i,i.exports,t),i.exports}(()=>{"use strict";function e(n){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(n)}var n=t(975),o="AMZ_WEB_SOCKET_MANAGER:",r="aws/subscribe",i="aws/heartbeat",c="aws/ping",a="disconnected",s={assertTrue:function(e,n){if(!e)throw new Error(n)},assertNotNull:function(t,o){return s.assertTrue(null!==t&&void 0!==e(t),(0,n.sprintf)("%s must be provided",o||"A value")),t},isNonEmptyString:function(e){return"string"==typeof e&&e.length>0},assertIsList:function(e,n){if(!Array.isArray(e))throw new Error(n+" is not an array")},isFunction:function(e){return!!(e&&e.constructor&&e.call&&e.apply)},isObject:function(n){return!("object"!==e(n)||null===n)},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e}},u=new RegExp("^(wss://)\\w*"),l=new RegExp("^(ws://127.0.0.1:)");s.validWSUrl=function(e){return u.test(e)||l.test(e)},s.getSubscriptionResponse=function(e,n,t){return{topic:e,content:{status:n?"success":"failure",topics:t}}},s.assertIsObject=function(e,n){if(!s.isObject(e))throw new Error(n+" is not an object!")},s.addJitter=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;n=Math.min(n,1);var t=Math.random()>.5?1:-1;return Math.floor(e+t*e*Math.random()*n)},s.isNetworkOnline=function(){return navigator.onLine},s.isNetworkFailure=function(e){return!(!e._debug||!e._debug.type)&&"NetworkingError"===e._debug.type},s.isMobile=function(){return/Android|webOS|Mobi|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},s.isMobileDisconnectFailure=function(e){var n,t;return s.isMobile()&&"TypeError"===(null==e||null===(n=e._debug)||void 0===n?void 0:n.type)&&"Load failed"===(null==e||null===(t=e._debug)||void 0===t?void 0:t.message)},s.isMobileFetchFailure=function(e){var n,t;return s.isMobile()&&"TypeError"===(null==e||null===(n=e._debug)||void 0===n?void 0:n.type)&&"Failed to fetch"===(null==e||null===(t=e._debug)||void 0===t?void 0:t.message)};const d=s;function p(e,n){return p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,n){return e.__proto__=n,e},p(e,n)}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}function g(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function b(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function v(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function m(e,n,t){return n&&v(e.prototype,n),t&&v(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function h(n){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var o,r=f(n);if(t){var i=f(this).constructor;o=Reflect.construct(r,arguments,i)}else o=r.apply(this,arguments);return function(n,t){if(t&&("object"===e(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(n)}(this,o)}}function y(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}var k=function(){function e(){b(this,e)}return m(e,[{key:"debug",value:function(e){}},{key:"info",value:function(e){}},{key:"warn",value:function(e){}},{key:"error",value:function(e){}},{key:"advancedLog",value:function(e){}}]),e}(),w=o,S={DEBUG:10,INFO:20,WARN:30,ERROR:40,ADVANCED_LOG:50},C=function(){function n(e){b(this,n),this.logMetaData=e||"",this.updateLoggerConfig()}return m(n,[{key:"hasLogMetaData",value:function(){return!!this.logMetaData}},{key:"writeToClientLogger",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(this.hasClientLogger()){var t="string"==typeof n?n:JSON.stringify(n,O()),o="string"==typeof this.logMetaData?this.logMetaData:JSON.stringify(this.logMetaData,O()),r="".concat(function(e){switch(e){case 10:return"DEBUG";case 20:return"INFO";case 30:return"WARN";case 40:return"ERROR";case 50:return"ADVANCED_LOG"}}(e)," ").concat(t);switch(o&&(r+=" ".concat(o)),e){case S.DEBUG:return this._clientLogger.debug(r)||r;case S.INFO:return this._clientLogger.info(r)||r;case S.WARN:return this._clientLogger.warn(r)||r;case S.ERROR:return this._clientLogger.error(r)||r;case S.ADVANCED_LOG:return this._advancedLogWriter?this._clientLogger[this._advancedLogWriter](r)||r:""}}}},{key:"isLevelEnabled",value:function(e){return e>=this._level}},{key:"hasClientLogger",value:function(){return null!==this._clientLogger}},{key:"getLogger",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.prefix||w;return e.logMetaData&&this.setLogMetaData(e.logMetaData),new L(this,function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?y(Object(t),!0).forEach((function(n){g(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):y(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}({prefix:n,logMetaData:this.logMetaData},e))}},{key:"setLogMetaData",value:function(e){this.logMetaData=e}},{key:"updateLoggerConfig",value:function(n){var t=n||{};this._level=t.level||S.INFO,this._advancedLogWriter="warn",t.advancedLogWriter&&(this._advancedLogWriter=t.advancedLogWriter),t.customizedLogger&&"object"===e(t.customizedLogger)?this.useClientLogger=!0:this.useClientLogger=!1,this._clientLogger=t.logger||this.selectLogger(t),this._logsDestination="NULL",t.debug&&(this._logsDestination="DEBUG"),t.logger&&(this._logsDestination="CLIENT_LOGGER")}},{key:"selectLogger",value:function(n){return n.customizedLogger&&"object"===e(n.customizedLogger)?n.customizedLogger:n.useDefaultLogger?W():null}}]),n}(),T=function(){function e(){b(this,e)}return m(e,[{key:"debug",value:function(){}},{key:"info",value:function(){}},{key:"warn",value:function(){}},{key:"error",value:function(){}},{key:"advancedLog",value:function(){}}]),e}(),L=function(e){!function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),n&&p(e,n)}(t,e);var n=h(t);function t(e,o){var r;return b(this,t),(r=n.call(this)).options=o||{},r.prefix=o.prefix||w,r.excludeTimestamp=o.excludeTimestamp,r.logManager=e,r}return m(t,[{key:"debug",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return this._log(S.DEBUG,n)}},{key:"info",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return this._log(S.INFO,n)}},{key:"warn",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return this._log(S.WARN,n)}},{key:"error",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return this._log(S.ERROR,n)}},{key:"advancedLog",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return this._log(S.ADVANCED_LOG,n)}},{key:"_shouldLog",value:function(e){return this.logManager.hasClientLogger()&&this.logManager.isLevelEnabled(e)}},{key:"_writeToClientLogger",value:function(e,n){return this.logManager.writeToClientLogger(e,n)}},{key:"_log",value:function(e,n){if(this._shouldLog(e)){var t=this.logManager.useClientLogger?n:this._convertToSingleStatement(n);return this._writeToClientLogger(e,t)}}},{key:"_convertToSingleStatement",value:function(e){var n=new Date(Date.now()).toISOString(),t=this.excludeTimestamp?"":"[".concat(n,"] ");(this.prefix||this.options.prefix)&&(t+=(this.options.prefix||this.prefix)+":");for(var o=0;o<e.length;o++){var r=e[o];t+=this._convertToString(r)+" "}return t}},{key:"_convertToString",value:function(e){try{if(!e)return"";if(d.isString(e))return e;if(d.isObject(e)&&d.isFunction(e.toString)){var n=e.toString();if(!n.startsWith("[object"))return n}return JSON.stringify(e)}catch(n){return console.error("Error while converting argument to string",e,n),""}}}]),t}(T);function O(){var n=new WeakSet;return function(t,o){if("object"===e(o)&&null!==o){if(n.has(o))return;n.add(o)}return o}}var W=function(){var e=new T;return e.debug=function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return console.debug.apply(window.console,[].concat(n))},e.info=function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return console.info.apply(window.console,[].concat(n))},e.warn=function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return console.warn.apply(window.console,[].concat(n))},e.error=function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return console.error.apply(window.console,[].concat(n))},e},I=function(){function e(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2e3;b(this,e),this.numAttempts=0,this.executor=n,this.hasActiveReconnection=!1,this.defaultRetry=t}return m(e,[{key:"retry",value:function(e){var n=this;this.hasActiveReconnection||(this.hasActiveReconnection=!0,setTimeout((function(){n._execute(e)}),this._getDelay()))}},{key:"_execute",value:function(e){this.hasActiveReconnection=!1,this.executor(e),this.numAttempts++}},{key:"connected",value:function(){this.numAttempts=0}},{key:"_getDelay",value:function(){var e=Math.pow(2,this.numAttempts)*this.defaultRetry;return e<=3e4?e:3e4}},{key:"getIsConnected",value:function(){return!this.numAttempts}}]),e}(),F=null,N=function(){var e,n=F.getLogger({prefix:o,excludeTimestamp:!0}),t=d.isNetworkOnline(),s={primary:null,secondary:null},u={reconnectWebSocket:!0,websocketInitFailed:!1,exponentialBackOffTime:1e3,exponentialTimeoutHandle:null,lifeTimeTimeoutHandle:null,webSocketInitCheckerTimeoutId:null,connState:null},l={connectWebSocketRetryCount:0,connectionAttemptStartTime:null,noOpenConnectionsTimestamp:null},p={pendingResponse:!1,intervalHandle:null},f={pendingResponse:!1,intervalHandle:null},g={initFailure:new Set,getWebSocketTransport:null,subscriptionUpdate:new Set,subscriptionFailure:new Set,topic:new Map,allMessage:new Set,connectionGain:new Set,connectionLost:new Set,connectionOpen:new Set,connectionClose:new Set,deepHeartbeatSuccess:new Set,deepHeartbeatFailure:new Set,topicFailure:new Set},b={connConfig:null,promiseHandle:null,promiseCompleted:!0},v={subscribed:new Set,pending:new Set,subscriptionHistory:new Set},m={responseCheckIntervalId:null,requestCompleted:!0,reSubscribeIntervalId:null,consecutiveFailedSubscribeAttempts:0,consecutiveNoResponseRequest:0},h=!1,y=new I((function(e){B(e).catch((function(){}))}));d.isMobile()&&null!==(e=window)&&void 0!==e&&e.document&&window.document.addEventListener("visibilitychange",(function(){y.getIsConnected()&&("hidden"===window.document.visibilityState?h=!0:setTimeout((function(){h=!1,O(s.primary)||O(s.secondary)||B().catch((function(){}))}),500))}));var k=new Set([r,"aws/unsubscribe",i,c]),w=setInterval((function(){if(t!==d.isNetworkOnline()){if(!(t=d.isNetworkOnline()))return void X(n.advancedLog("Network offline"));var e=N();t&&(!e||L(e,WebSocket.CLOSING)||L(e,WebSocket.CLOSED))&&(X(n.advancedLog("Network online, connecting to WebSocket server")),B().catch((function(){})))}}),250),S=function(e,t){e.forEach((function(e){try{e(t)}catch(e){X(n.error("Error executing callback",e))}}))},C=function(e){if(null===e)return"NULL";switch(e.readyState){case WebSocket.CONNECTING:return"CONNECTING";case WebSocket.OPEN:return"OPEN";case WebSocket.CLOSING:return"CLOSING";case WebSocket.CLOSED:return"CLOSED";default:return"UNDEFINED"}},T=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";X(n.debug("["+e+"] Primary WebSocket: "+C(s.primary)+" | Secondary WebSocket: "+C(s.secondary)))},L=function(e,n){return e&&e.readyState===n},O=function(e){return L(e,WebSocket.OPEN)},W=function(e){return null===e||void 0===e.readyState||L(e,WebSocket.CLOSED)},N=function(){return null!==s.secondary?s.secondary:s.primary},_=function(){return O(N())},E=function(){if(f.pendingResponse&&(X(n.debug("aws/ping deep heartbeat response not received")),S(g.deepHeartbeatFailure,{timestamp:Date.now(),error:"aws/ping response is not received"}),clearInterval(f.intervalHandle),f.pendingResponse=!1),p.pendingResponse)return X(n.warn("Heartbeat response not received")),clearInterval(p.intervalHandle),p.intervalHandle=null,p.pendingResponse=!1,void B().catch((function(){}));_()?(X(n.debug("Sending aws/ping deep heartbeat")),N().send(q(c)),f.pendingResponse=!0,X(n.debug("Sending heartbeat")),N().send(q(i)),p.pendingResponse=!0):(X(n.debug("Failed to send aws/ping deep heartbeat since WebSocket is not open")),S(g.deepHeartbeatFailure,{timestamp:Date.now(),error:"Unable to send message to aws/ping because websocket connection is not established."}),X(n.warn("Failed to send heartbeat since WebSocket is not open")),T("sendHeartBeat"),B().catch((function(){})))},D=function(){X(n.advancedLog("Reset Websocket state")),u.exponentialBackOffTime=1e3,p.pendingResponse=!1,f.pendingResponse=!1,u.reconnectWebSocket=!0,clearTimeout(u.lifeTimeTimeoutHandle),clearInterval(p.intervalHandle),clearInterval(f.intervalHandle),clearTimeout(u.exponentialTimeoutHandle),clearTimeout(u.webSocketInitCheckerTimeoutId),p.intervalHandle=null},R=function(){m.consecutiveFailedSubscribeAttempts=0,m.consecutiveNoResponseRequest=0,clearInterval(m.responseCheckIntervalId),clearInterval(m.reSubscribeIntervalId)},M=function(){l.connectWebSocketRetryCount=0,l.connectionAttemptStartTime=null,l.noOpenConnectionsTimestamp=null},x=function(){y.connected();try{X(n.advancedLog("WebSocket connection established!")),T("webSocketOnOpen"),null!==u.connState&&u.connState!==a||S(g.connectionGain),u.connState="connected";var e=Date.now();S(g.connectionOpen,{connectWebSocketRetryCount:l.connectWebSocketRetryCount,connectionAttemptStartTime:l.connectionAttemptStartTime,noOpenConnectionsTimestamp:l.noOpenConnectionsTimestamp,connectionEstablishedTime:e,timeToConnect:e-l.connectionAttemptStartTime,timeWithoutConnection:l.noOpenConnectionsTimestamp?e-l.noOpenConnectionsTimestamp:null}),M(),D(),N().openTimestamp=Date.now(),0===v.subscribed.size&&O(s.secondary)&&P(s.primary,"[Primary WebSocket] Closing WebSocket"),(v.subscribed.size>0||v.pending.size>0)&&(O(s.secondary)&&X(n.info("Subscribing secondary websocket to topics of primary websocket")),v.subscribed.forEach((function(e){v.subscriptionHistory.add(e),v.pending.add(e)})),v.subscribed.clear(),H()),E(),null!==p.intervalHandle&&clearInterval(p.intervalHandle),p.intervalHandle=setInterval(E,1e4);var t=1e3*b.connConfig.webSocketTransport.transportLifeTimeInSeconds;X(n.debug("Scheduling WebSocket manager reconnection, after delay "+t+" ms")),u.lifeTimeTimeoutHandle=setTimeout((function(){X(n.debug("Starting scheduled WebSocket manager reconnection")),B().catch((function(){}))}),t)}catch(e){X(n.error("Error after establishing WebSocket connection",e))}},A=function(e){T("webSocketOnError"),X(n.advancedLog("WebSocketManager Error, error_event: ",JSON.stringify(e))),y.getIsConnected()?B().catch((function(){})):y.retry()},j=function(e){if(void 0!==e.data&&""!==e.data){var t=JSON.parse(e.data);switch(t.topic){case r:if(X(n.debug("Subscription Message received from webSocket server")),m.requestCompleted=!0,m.consecutiveNoResponseRequest=0,"success"===t.content.status)m.consecutiveFailedSubscribeAttempts=0,t.content.topics.forEach((function(e){v.subscriptionHistory.delete(e),v.pending.delete(e),v.subscribed.add(e)})),0===v.subscriptionHistory.size?O(s.secondary)&&(X(n.debug("Successfully subscribed secondary websocket to all topics of primary websocket")),P(s.primary,"[Primary WebSocket] Closing WebSocket")):H(),S(g.subscriptionUpdate,t);else{if(clearInterval(m.reSubscribeIntervalId),++m.consecutiveFailedSubscribeAttempts,5===m.consecutiveFailedSubscribeAttempts)return S(g.subscriptionFailure,t),void(m.consecutiveFailedSubscribeAttempts=0);m.reSubscribeIntervalId=setInterval((function(){H()}),500)}break;case i:X(n.debug("Heartbeat response received")),p.pendingResponse=!1,null===p.intervalHandle&&(p.intervalHandle=setInterval(E,1e4));break;case c:X(n.debug("aws/ping deep heartbeat received")),f.pendingResponse=!1,200===t.statusCode?S(g.deepHeartbeatSuccess,{timestamp:Date.now()}):S(g.deepHeartbeatFailure,{timestamp:Date.now(),statusCode:t.statusCode,statusContent:t.statusContent});break;default:if(t.topic){if(X(n.advancedLog("Message received for topic ",t.topic)),O(s.primary)&&O(s.secondary)&&0===v.subscriptionHistory.size&&this===s.primary)return void X(n.warn("Ignoring Message for Topic "+t.topic+", to avoid duplicates"));if(0===g.allMessage.size&&0===g.topic.size)return void X(n.warn("No registered callback listener for Topic",t.topic));X(n.advancedLog("WebsocketManager invoke callbacks for topic success ",t.topic)),S(g.allMessage,t),g.topic.has(t.topic)&&S(g.topic.get(t.topic),t)}else t.message?(X(n.advancedLog("WebSocketManager Message Error",t)),S(g.topicFailure,{timestamp:Date.now(),errorMessage:t.message,connectionId:t.connectionId,requestId:t.requestId})):X(n.advancedLog("Invalid incoming message",t))}}else X(n.warn("An empty message has been received on Websocket. Ignoring"))},H=function e(){if(m.consecutiveNoResponseRequest>3)return X(n.warn("Ignoring subscribePendingTopics since we have exhausted max subscription retries with no response")),void S(g.subscriptionFailure,d.getSubscriptionResponse(r,!1,Array.from(v.pending)));_()?0!==Array.from(v.pending).length&&(clearInterval(m.responseCheckIntervalId),N().send(q(r,{topics:Array.from(v.pending)})),m.requestCompleted=!1,m.responseCheckIntervalId=setInterval((function(){m.requestCompleted||(++m.consecutiveNoResponseRequest,e())}),1e3)):X(n.warn("Ignoring subscribePendingTopics call since Default WebSocket is not open"))},P=function(e,t){L(e,WebSocket.CONNECTING)||L(e,WebSocket.OPEN)?e.close(1e3,t):X(n.warn("Ignoring WebSocket Close request, WebSocket State: "+C(e)))},G=function(e){P(s.primary,"[Primary] WebSocket "+e),P(s.secondary,"[Secondary] WebSocket "+e)},z=function(e){D(),R(),X(n.advancedLog("WebSocket Initialization failed - Terminating and cleaning subscriptions",e)),u.websocketInitFailed=!0,G("Terminating WebSocket Manager"),clearInterval(w),S(g.initFailure,{connectWebSocketRetryCount:l.connectWebSocketRetryCount,connectionAttemptStartTime:l.connectionAttemptStartTime,reason:e}),M()},q=function(e,n){return JSON.stringify({topic:e,content:n})},U=function(e){return!!(d.isObject(e)&&d.isObject(e.webSocketTransport)&&d.isNonEmptyString(e.webSocketTransport.url)&&d.validWSUrl(e.webSocketTransport.url)&&1e3*e.webSocketTransport.transportLifeTimeInSeconds>=3e5)||(X(n.error("Invalid WebSocket Connection Configuration",e)),!1)},B=function(){return h?(X(n.debug("Chat widget backgrounded. Ignoring getWebSocketConnConfig requests until chat widget foregrounded.")),Promise.resolve()):d.isNetworkOnline()?u.websocketInitFailed?(X(n.debug("WebSocket Init had failed, ignoring this getWebSocketConnConfig request")),Promise.resolve({webSocketConnectionFailed:!0})):b.promiseCompleted?(D(),X(n.advancedLog("Fetching new WebSocket connection configuration")),l.connectionAttemptStartTime=l.connectionAttemptStartTime||Date.now(),b.promiseCompleted=!1,b.promiseHandle=g.getWebSocketTransport(),b.promiseHandle.then((function(e){return b.promiseCompleted=!0,X(n.advancedLog("Successfully fetched webSocket connection configuration")),U(e)?(b.connConfig=e,b.connConfig.urlConnValidTime=Date.now()+85e3,J()):(z("Invalid WebSocket connection configuration: "+e),{webSocketConnectionFailed:!0})}),(function(e){return b.promiseCompleted=!0,X(n.advancedLog("Failed to fetch webSocket connection configuration",e)),d.isNetworkFailure(e)||d.isMobileDisconnectFailure(e)||d.isMobileFetchFailure(e)?(X(n.advancedLog("Retrying fetching new WebSocket connection configuration",e)),y.retry()):z("Failed to fetch webSocket connection configuration: "+JSON.stringify(e)),{webSocketConnectionFailed:!0}}))):(X(n.debug("There is an ongoing getWebSocketConnConfig request, this request will be ignored")),Promise.resolve({webSocketConnectionFailed:!0})):(X(n.advancedLog("Network offline, ignoring this getWebSocketConnConfig request")),Promise.resolve({webSocketConnectionFailed:!0}))},J=function(){if(u.websocketInitFailed)return X(n.info("web-socket initializing had failed, aborting re-init")),{webSocketConnectionFailed:!0};if(!d.isNetworkOnline())return X(n.warn("System is offline aborting web-socket init")),{webSocketConnectionFailed:!0};X(n.advancedLog("Initializing Websocket Manager")),T("initWebSocket");try{if(U(b.connConfig)){var e=null;return O(s.primary)?(X(n.debug("Primary Socket connection is already open")),L(s.secondary,WebSocket.CONNECTING)||(X(n.debug("Establishing a secondary web-socket connection")),y.numAttempts=0,s.secondary=V()),e=s.secondary):(L(s.primary,WebSocket.CONNECTING)||(X(n.debug("Establishing a primary web-socket connection")),s.primary=V()),e=s.primary),u.webSocketInitCheckerTimeoutId=setTimeout((function(){O(e)||function(){l.connectWebSocketRetryCount++;var e=d.addJitter(u.exponentialBackOffTime,.3);Date.now()+e<=b.connConfig.urlConnValidTime?(X(n.advancedLog("Scheduling WebSocket reinitialization, after delay "+e+" ms")),u.exponentialTimeoutHandle=setTimeout((function(){return J()}),e),u.exponentialBackOffTime*=2):(X(n.advancedLog("WebSocket URL cannot be used to establish connection")),B().catch((function(){})))}()}),1e3),{webSocketConnectionFailed:!1}}}catch(e){return X(n.error("Error Initializing web-socket-manager",e)),z("Failed to initialize new WebSocket: "+e.message),{webSocketConnectionFailed:!0}}},V=function(){var e=new WebSocket(b.connConfig.webSocketTransport.url);return e.addEventListener("open",x),e.addEventListener("message",j),e.addEventListener("error",A),e.addEventListener("close",(function(t){return function(e,t){var o={openTimestamp:t.openTimestamp,closeTimestamp:Date.now(),connectionDuration:Date.now()-t.openTimestamp,code:e.code,reason:e.reason,wasClean:e.wasClean},r="Close Code: ".concat(o.code," - Reason: ").concat(o.reason," - WasClean: ").concat(o.wasClean),i="OpenTimestamp: ".concat(o.openTimestamp," - CloseTimestamp: ").concat(o.closeTimestamp," - ConnectionDuration: ").concat(o.connectionDuration);X(n.advancedLog("WebSocket connection is closed. ",r)),X(n.advancedLog("Closed WebSocket connection duration: ",i)),T("webSocketOnClose before-cleanup"),S(g.connectionClose,o),W(s.primary)&&(s.primary=null),W(s.secondary)&&(s.secondary=null),u.reconnectWebSocket&&(O(s.primary)||O(s.secondary)?W(s.primary)&&O(s.secondary)&&(X(n.debug("[Primary] WebSocket Cleanly Closed")),s.primary=s.secondary,s.secondary=null):(X(n.warn("Neither primary websocket and nor secondary websocket have open connections, attempting to re-establish connection")),u.connState===a?X(n.info("Ignoring connectionLost callback invocation")):(S(g.connectionLost,{openTimestamp:t.openTimestamp,closeTimestamp:Date.now(),connectionDuration:Date.now()-t.openTimestamp,code:e.code,reason:e.reason}),l.noOpenConnectionsTimestamp=Date.now()),u.connState=a,B().catch((function(){}))),T("webSocketOnClose after-cleanup"))}(t,e)})),e},X=function(e){return e&&"function"==typeof e.sendInternalLogToServer&&e.sendInternalLogToServer(),e};this.init=function(e){if(d.assertTrue(d.isFunction(e),"transportHandle must be a function"),null===g.getWebSocketTransport)return g.getWebSocketTransport=e,B();X(n.warn("Web Socket Manager was already initialized"))},this.onInitFailure=function(e){return X(n.advancedLog("Initializing Websocket Manager Failure callback registered")),d.assertTrue(d.isFunction(e),"cb must be a function"),g.initFailure.add(e),u.websocketInitFailed&&e(),function(){return g.initFailure.delete(e)}},this.onConnectionOpen=function(e){return X(n.advancedLog("Websocket connection open callback registered")),d.assertTrue(d.isFunction(e),"cb must be a function"),g.connectionOpen.add(e),function(){return g.connectionOpen.delete(e)}},this.onConnectionClose=function(e){return X(n.advancedLog("Websocket connection close callback registered")),d.assertTrue(d.isFunction(e),"cb must be a function"),g.connectionClose.add(e),function(){return g.connectionClose.delete(e)}},this.onConnectionGain=function(e){return X(n.advancedLog("Websocket connection gain callback registered")),d.assertTrue(d.isFunction(e),"cb must be a function"),g.connectionGain.add(e),_()&&e(),function(){return g.connectionGain.delete(e)}},this.onConnectionLost=function(e){return X(n.advancedLog("Websocket connection lost callback registered")),d.assertTrue(d.isFunction(e),"cb must be a function"),g.connectionLost.add(e),u.connState===a&&e(),function(){return g.connectionLost.delete(e)}},this.onSubscriptionUpdate=function(e){return d.assertTrue(d.isFunction(e),"cb must be a function"),g.subscriptionUpdate.add(e),function(){return g.subscriptionUpdate.delete(e)}},this.onSubscriptionFailure=function(e){return X(n.advancedLog("Websocket subscription failure callback registered")),d.assertTrue(d.isFunction(e),"cb must be a function"),g.subscriptionFailure.add(e),function(){return g.subscriptionFailure.delete(e)}},this.onMessage=function(e,n){return d.assertNotNull(e,"topicName"),d.assertTrue(d.isFunction(n),"cb must be a function"),g.topic.has(e)?g.topic.get(e).add(n):g.topic.set(e,new Set([n])),function(){return g.topic.get(e).delete(n)}},this.onAllMessage=function(e){return d.assertTrue(d.isFunction(e),"cb must be a function"),g.allMessage.add(e),function(){return g.allMessage.delete(e)}},this.subscribeTopics=function(e){d.assertNotNull(e,"topics"),d.assertIsList(e),e.forEach((function(e){v.subscribed.has(e)||v.pending.add(e)})),m.consecutiveNoResponseRequest=0,H()},this.sendMessage=function(e){if(d.assertIsObject(e,"payload"),void 0===e.topic||k.has(e.topic))X(n.warn("Cannot send message, Invalid topic: "+e.topic));else{try{e=JSON.stringify(e)}catch(t){return void X(n.warn("Error stringify message",e))}_()?N().send(e):X(n.warn("Cannot send message, web socket connection is not open"))}},this.onDeepHeartbeatSuccess=function(e){return X(n.advancedLog("Websocket deep heartbeat success callback registered")),d.assertTrue(d.isFunction(e),"cb must be a function"),g.deepHeartbeatSuccess.add(e),function(){return g.deepHeartbeatSuccess.delete(e)}},this.onDeepHeartbeatFailure=function(e){return X(n.advancedLog("Websocket deep heartbeat failure callback registered")),d.assertTrue(d.isFunction(e),"cb must be a function"),g.deepHeartbeatFailure.add(e),function(){return g.deepHeartbeatFailure.delete(e)}},this.onTopicFailure=function(e){return X(n.advancedLog("Websocket topic failure callback registered")),d.assertTrue(d.isFunction(e),"cb must be a function"),g.topicFailure.add(e),function(){return g.topicFailure.delete(e)}},this.closeWebSocket=function(){D(),R(),u.reconnectWebSocket=!1,clearInterval(w),G("User request to close WebSocket")},this.terminateWebSocketManager=z},_={create:function(e){return F||(F=new C(e)),F.hasLogMetaData()||F.setLogMetaData(e),new N},setGlobalConfig:function(e){var n=e&&e.loggerConfig;F||(F=new C),F.updateLoggerConfig(n);var t=e&&e.webSocketManagerConfig,o=t&&t.isNetworkOnline;o&&"function"==typeof o&&(d.isNetworkOnline=o)},LogLevel:S,Logger:k};global.connect=global.connect||{},connect.WebSocketManager=_})()})();
//# sourceMappingURL=amazon-connect-websocket-manager.js.map

const WebSocketManager = connect.WebSocketManager;
connect.WebSocketManager = currentWebsocketManager || WebSocketManager;
export default WebSocketManager;
